#-----------Data------------#
library(data.table)
library(openxlsx)
library("ordinal")
a<-read.csv("/data_50t/zhangliye/zhangliye/network/data_ing/result/ordinal/depression/depression_network.csv",header = FALSE)
b<-unlist(a)
sigma<-matrix(b,nrow = 20)
sigma0<-sigma
sigma0[lower.tri(sigma0,diag=T)]<- 0
EDGE <- which(sigma0!=0,arr.ind=T)
gene <- fread("/data_50t/zhangliye/zhangliye/network/data_ing/result/ordinal/depression/dpression_dpr_genescale.txt",header=T)
#gene <- fread("/data_50t/zhangliye/zhangliye/network/data_ing/result/ordinal/depression/dpression_bslmm_genescale.txt",header=T)
PC<-fread("/data_50t/zhangliye/data/SEXandPC_337129.txt", header=T)
depression <- fread("/data_200t/kuazuxue/data/UK/UK_Catetgory/Bipolar_Depression.txt",header=T)
rname <- NULL
  for (i in 1:dim(depression)[1]){
   rname[i] <- i
  }
depression <- as.data.frame(depression)
rownames(depression) <- rname
outcome <-t(subset(t(depression),select=colnames(gene)))
outcome <- as.data.frame(outcome)
outcome <- na.omit(outcome)
outcome$Bipolar_Depression[which(outcome$Bipolar_Depression!=0)] <- 1
gene <- subset(gene,select=rownames(outcome))
index1<-which(PC$eid %in% colnames(gene))
PC <- as.data.frame(PC)
PC<-PC[index1,]
PC[,1] <- factor(PC[,1], 
    levels=c(0,1), 
    labels=c("female","male"))
DataSet <- t(gene)
colname_node<-apply(matrix(1:ncol(DataSet)),1,RENAME_node,varname="X")
colnames(DataSet)<-colname_node
DataSet<-data.frame(DataSet,outcome)
DataSet<-cbind(DataSet,PC)
write.table(DataSet,paste0("/data_50t/zhangliye/zhangliye/network/data_ing/result/Bipolar_depression/bslmm_dataset.txt"), quote=F,col.names=T,row.names=F)
#-----------PMI----------------#
    DenPreData <- apply(EDGE,1,denPre2D,DataPre=DataSet)
    colname<-apply(EDGE,1,RENAME,varname="V")
    colnames(DenPreData)<-colname
    KDEFitData<-cbind(DataSet,DenPreData)
    KDEFitData<-data.frame(KDEFitData)    
#------------PM-----------------#
    MDIPreData<-apply(EDGE,1,MDIF,data=DataSet)
    colname<-apply(EDGE,1,RENAME,varname="V")
    colnames(MDIPreData)<-colname
    MDIFitData<-cbind(DataSet,MDIPreData)
    MDIFitData<-data.frame(MDIFitData)
#--------------Regression----------------#
KDEfit<-glm(factor(Bipolar_Depression)~X1+X2+X3+X4+X5+X6+X7+X8+X9+X10+X11+X12+X13+X14+X15+X16+X17+X18+X19+X20+V2_3+V3_4+V1_5+V4_6+V5_6+V4_7+V6_7+V7_9+V8_9+V10_11+V4_12+V8_12+V9_12+V11_12+V12_13
+V13_14+V12_15+V14_15+V12_16+V15_16+V8_17+V8_19+V18_19+V11_20+V12_20+sex+PC1+PC2+PC3+PC4+PC5+PC6+PC7+PC8+PC9+PC10,data=KDEFitData,family = binomial(link = "logit"),control = list(maxit=100))    
MDIfit<-glm(factor(Bipolar_Depression)~X1+X2+X3+X4+X5+X6+X7+X8+X9+X10+X11+X12+X13+X14+X15+X16+X17+X18+X19+X20+V2_3+V3_4+V1_5+V4_6+V5_6+V4_7+V6_7+V7_9+V8_9+V10_11+V4_12+V8_12+V9_12+V11_12+V12_13
+V13_14+V12_15+V14_15+V12_16+V15_16+V8_17+V8_19+V18_19+V11_20+V12_20+sex+PC1+PC2+PC3+PC4+PC5+PC6+PC7+PC8+PC9+PC10, data=MDIFitData,family = binomial(link = "logit"),control = list(maxit=100))

coe <- c("intercept","X1","X2","X3","X4","X5","X6","X7","X8","X9","X10","X11","X12","X13","X14","X15","X16","X17","X18","X19","X20","V2_3","V3_4","V1_5","V4_6","V5_6","V4_7","V6_7","V7_9","V8_9","V10_11","V4_12","V8_12","V9_12","V11_12","V12_13",
"V13_14","V12_15","V14_15","V12_16","V15_16","V8_17","V8_19","V18_19","V11_20","V12_20","SEX","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10")

KDEtemp<-summary(KDEfit)
KDEtem<-KDEtemp$coefficients
KDEtem <- round(KDEtem,5)
KDEtem <- cbind(coe,KDEtem)

MDItemp<-summary(MDIfit)
MDItem<-MDItemp$coefficients
MDItem <- round(MDItem,5)
MDItem <- cbind(coe,MDItem)

sheets = list("KDEnode&edge" =KDEtem,"MDInode&edge" = MDItem)
write.xlsx(sheets,"/data_50t/zhangliye/zhangliye/network/data_ing/result/Bipolar_depression/hsa04730/bslmm_hsa04730.xlsx")
